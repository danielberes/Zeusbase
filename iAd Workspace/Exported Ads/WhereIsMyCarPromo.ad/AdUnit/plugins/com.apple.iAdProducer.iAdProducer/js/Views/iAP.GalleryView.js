
/**
*
* Copyright Â© 2009-2011 Apple Inc.  All rights reserved.
*
**/

iAd.Class({name:"iAP.GalleryView",superclass:iAd.ScrollView,mixins:[iAd.CellContainer],synthesizedProperties:["focusedIndex","orientation","pageControl","pageControlOffset","pageControlPosition","pageControlVisible","pageControlColor","scaleFactor","cellLength","paddingX","paddingY"],archivedProperties:["focusedIndex","orientation","pageControl","pageControlOffset","pageControlPosition","pageControlVisible","pageControlColor","scaleFactor","cellLength","paddingX","paddingY"],cssClassName:"iap-gallery-view",collectionAccessor:"galleryViews"});iAP.GalleryView.VERTICAL_ORIENTATION=0;iAP.GalleryView.HORIZONTAL_ORIENTATION=1;iAP.GalleryView.PAGE_CONTROL_POSITION_BEFORE="before";iAP.GalleryView.PAGE_CONTROL_POSITION_AFTER="after";iAP.GalleryView.HORIZONTAL_CLASS_NAME="iap-horizontal";iAP.GalleryView.VERTICAL_CLASS_NAME="iap-vertical";iAP.GalleryView.ANIMATED_CLASS_NAME="iap-animated";iAP.GalleryView.CLIPS_TO_BOUNDS_CLASS_NAME="iap-clips-to-bounds";iAP.GalleryView.prototype.init=function(a){this._orientation=iAP.GalleryView.HORIZONTAL_ORIENTATION;this._pageControlOffset=35;this._pageControlPosition=iAP.GalleryView.PAGE_CONTROL_POSITION_AFTER;this._pageControlVisible=true;this._pageControlColor="";this._scaleFactor=1;this._cellLength="100%";this._paddingX=20;this._paddingY=0;this._focusedIndex=0;iAd.CellContainer.init.call(this,a);this.callSuper(a);if(!iAP.Context.IS_IOS&&iAP.Context.projectIsOfType("iTunesProject")&&!iAP.Context.IS_IAD_PRODUCER){this.layer.addEventListener("mousewheel",this,false)}};iAP.GalleryView.prototype.setupLayer=function(){this.callSuper();this.setupChildLayers();this.dataSource=new iAd.CellContainerDeclarativeDataSource(this.hostingLayer,true)};iAP.GalleryView.prototype.createLayer=function(){this.callSuper();this.setupChildLayers()};iAP.GalleryView.prototype.layerWasCreated=function(){this.callSuper();this.pageSize=this.size;this.pagingEnabled=true;this.verticalScrollEnabled=false;this.showsHorizontalScrollIndicator=false;this.showsVerticalScrollIndicator=false;this.pageControl=new iAd.PageControl();this.layer.appendChild(this.pageControl.layer);this.pageControl.addEventListener(iAd.Control.VALUE_CHANGE_EVENT,this,false);this.addEventListener(iAd.ScrollView.DID_END_SCROLLING_ANIMATION,this,false);this.addEventListener(iAd.ScrollView.DID_END_DECELERATING,this,false)};iAP.GalleryView.prototype.setValueForAttribute=function(b,a){if(a==="ad-orientation"){this.orientation=(b==="vertical")?iAP.GalleryView.VERTICAL_ORIENTATION:iAP.GalleryView.HORIZONTAL_ORIENTATION}else{if(a==="ad-cell-length"){this.setCellLength(b)}else{this.callSuper(b,a)}}};iAP.GalleryView.prototype.initWithDeclarativeBacking=function(){this.callSuper();this.reloadData()};iAP.GalleryView.prototype.layerWasInsertedIntoDocument=function(){this.callSuper();if(this.dataSource&&this.cells.length==0){this.reloadData()}};iAP.GalleryView.prototype.setClipsToBounds=function(a){this._clipsToBounds=a;this.layer.toggleClassName(iAP.GalleryView.CLIPS_TO_BOUNDS_CLASS_NAME,a)};iAP.GalleryView.prototype.focusCellAtIndexAnimated=function(d,e,c){this.clearMousewheel();if(!c&&d==this._focusedIndex){return}var b=this.cellAtIndex(d);if(b){this.willFocusCell(b,d,e)}this._focusedIndex=d;var a=this.pointFromIndex(d);this.setContentOffsetAnimated(a,e);if(!e){if(b){this.didFocusCell(b,d,false);this.pageControl.setCurrentPage(d)}}else{this._isAnimatingFocusedCell=true}};iAP.GalleryView.prototype.updateLayoutAnimated=function(d){if(d){this.layer.addClassName(iAP.GalleryView.ANIMATED_CLASS_NAME)}this.updateHostingLayer();this.layoutCells();this.displayVisibleCells(true);var a=this.pointFromIndex(this._focusedIndex);this.setContentOffsetAnimated(a,d);this.layoutPageControl();this.syncPageControl();if(d){var c=this.layer;var b=iAd.ScrollView.PAGING_TRANSITION_DURATION*1000;clearTimeout(this.animationTimeout);this.animationTimeout=setTimeout(function(){c.removeClassName(iAP.GalleryView.ANIMATED_CLASS_NAME)},b)}};iAP.GalleryView.prototype.insertCellsAtIndexesAnimated=function(a,b){iAd.CellContainer.insertCellsAtIndexesAnimated.apply(this,arguments);a.forEach(function(d){var c=this.cellAtIndex(d);c.userInteractionEnabled=true;c.addEventListener(iAd.View.ACTIVATE_EVENT,this)},this)};iAP.GalleryView.prototype.removeCellsAtIndexesAnimated=function(a,b){a.forEach(function(d){var c=this.cellAtIndex(d);c.removeEventListener(iAd.View.ACTIVATE_EVENT,this)},this);iAd.CellContainer.removeCellsAtIndexesAnimated.apply(this,arguments)};iAP.GalleryView.prototype.layoutCells=function(){var d=this.largerDimension();var b=this.smallerDimension();var c=this.size.width;var a=this.size.height;if(this.isVertical()){a=this.isCellLengthPercentage()?this.size.height*this.cellLength:this.cellLength}else{c=this.isCellLengthPercentage()?this.size.width*this.cellLength:this.cellLength}var f=new iAd.Size(c-this.paddingX,a-this.paddingY);this.pageSize=new iAd.Size(c,a);var e=this.size[d]-this.pageSize[d];this.cells.forEach(function(h,i){h.size=f;var j=this.pageSize[d]*i+e/2;var g=this.isVertical()?new iAd.Point(this.paddingX/2,j+this.paddingY/2):new iAd.Point(j+this.paddingX/2,this.paddingY/2);h.position=g},this);this.displayVisibleCells();this.scaleCells()};iAP.GalleryView.prototype.updateHostingLayer=function(){var b=this.largerDimension();var a=this.smallerDimension();this._hostingLayer.style[b]=(this.numberOfCells*this.pageSize[b]+this.size[b]-this.pageSize[b])+"px";this._hostingLayer.style[a]=this.size[a]+"px"};iAP.GalleryView.prototype.reloadData=function(){iAd.CellContainer.reloadData.call(this);this.displayVisibleCells(true);var a=this.archivedProperties;if(a){this.focusCellAtIndexAnimated(a.focusedIndex,false);delete this.archivedProperties}};iAP.GalleryView.prototype.setFocusedIndex=function(a){this.focusCellAtIndexAnimated(a,false)};iAP.GalleryView.prototype.setOrientation=function(b){if(this._orientation==b){return}this._orientation=b;var d=this.isVertical();var c=d?iAP.GalleryView.HORIZONTAL_CLASS_NAME:iAP.GalleryView.VERTICAL_CLASS_NAME;var a=d?iAP.GalleryView.VERTICAL_CLASS_NAME:iAP.GalleryView.HORIZONTAL_CLASS_NAME;this.layer.removeClassName(c);this.layer.addClassName(a);this.updateLayoutAnimated(false)};iAP.GalleryView.prototype.setPageControlOffset=function(a){if(a===this.pageControlOffset){return}this._pageControlOffset=a;this.layoutPageControl()};iAP.GalleryView.prototype.setPageControlPosition=function(a){if(a===this.pageControlPosition){return}this._pageControlPosition=a;this.layoutPageControl()};iAP.GalleryView.prototype.setPageControlVisible=function(a){this._pageControlVisible=a;this.pageControl.hidden=!a};iAP.GalleryView.prototype.setPageControlColor=function(a){this._pageControlColor=a;this.pageControl.setColor(a)};iAP.GalleryView.prototype.setScaleFactor=function(a){if(a>1||a===this.scaleFactor){return}this._scaleFactor=a;this.scaleCells()};iAP.GalleryView.prototype.getCellLength=function(){var a=this._cellLength;if(this.isCellLengthPercentage()){a=Math.min(1,parseFloat(a)/100)}else{a=Math.min(parseInt(a,10),this.size[this.largerDimension()])}return a};iAP.GalleryView.prototype.setCellLength=function(a){if(a==this.cellLength){return}this._cellLength=a;this.updateLayoutAnimated(false)};iAP.GalleryView.prototype.setPaddingX=function(a){if(this._paddingX==a){return}this._paddingX=a;this.updateLayoutAnimated(false)};iAP.GalleryView.prototype.setPaddingY=function(a){if(this._paddingY==a){return}this._paddingY=a;this.updateLayoutAnimated(false)};iAP.GalleryView.prototype.setSize=function(a){if(this._size==a){return}this.callSuper(a);this.updateLayoutAnimated(false)};iAP.GalleryView.prototype.setContentOffsetAnimated=function(a,c){if(a&&this.contentOffset&&a.equals(this.contentOffset)){return}this.callSuper(a,c);this.scaleCellsAnimated(c);var b=this.indexFromPoint(a);if(b>this._previousDisplayedIndex+1||b<this._previousDisplayedIndex-1){this.callMethodNameAfterDelay("displayVisibleCells",0)}};iAP.GalleryView.prototype.setContentSize=function(a){return};iAP.GalleryView.prototype.layoutPageControl=function(){var c=this.largerDimension();this.pageControl.size=new iAd.Size(this.size[c],iAd.PageControl.DEFAULT_SIZE);var a=0;var e=0;var b=this.pageControlPosition===iAP.GalleryView.PAGE_CONTROL_POSITION_BEFORE;var d=b?-this.pageControlOffset:this.pageControlOffset;if(this.isVertical()){a=b?iAd.PageControl.DEFAULT_SIZE:this.size.width;a+=d;this.pageControl.position=new iAd.Point(a,e);this.pageControl.layer.style.WebkitTransform="rotate(90deg)"}else{e=b?0:this.size.height-this.pageControl.size.height;e+=d;this.pageControl.position=new iAd.Point(a,e)}};iAP.GalleryView.prototype.syncPageControl=function(){this.pageControl.numberOfPages=this.numberOfCells;if(this.pageControl.currentPage!==this.focusedIndex){this.pageControl.setCurrentPage(this.focusedIndex)}this.setPageControlVisible(this._pageControlVisible)};iAP.GalleryView.prototype.handleEvent=function(b){this.callSuper(b);switch(b.type){case iAd.ScrollView.DID_END_SCROLLING_ANIMATION:case iAd.ScrollView.DID_END_DECELERATING:var a=this.indexFromPoint();if(this._isAnimatingFocusedCell||this._focusedIndex!=a){if(!this._isAnimatingFocusedCell){this.willFocusCell(this.cellAtIndex(a),a,true)}delete this._isAnimatingFocusedCell;this._focusedIndex=a;this.displayVisibleCells();this.didFocusCell(this.cellAtIndex(a),a,true);this.pageControl.setCurrentPage(a)}break;case"mousewheel":this.handleMousewheel(b);break;case iAd.Control.VALUE_CHANGE_EVENT:if(b.ad.sender==this.pageControl){this.focusCellAtIndexAnimated(this.pageControl.currentPage,true)}break;case iAd.View.ACTIVATE_EVENT:var a=this.cells.indexOf(b.ad.sender);if(a!=-1){this.focusCellAtIndexAnimated(a,true)}break}};iAP.GalleryView.prototype.touchesBegan=function(a){this.clearMousewheel();this.callSuper(a)};iAP.GalleryView.prototype.clearMousewheel=function(){if(this._scrolling){this._scrollingTimer&&clearTimeout(this._scrollingTimer);delete this._scrolling;this._scrollingCumulativeDelta=0;this.dispatchNotification(iAd.ScrollView.DID_END_DRAGGING,this.delegate)}};iAP.GalleryView.prototype.handleMousewheel=function(e){var f=this.isHorizontal()?e.wheelDeltaX:e.wheelDeltaY;if(Math.abs(f)>Math.abs(e[this.isHorizontal()?"wheelDeltaY":"wheelDeltaX"])){e.preventDefault();if(!this._scrolling){this._scrolling=true;this._scrollingCumulativeDelta=0;this.dispatchNotification(iAd.ScrollView.WILL_BEGIN_DRAGGING,this.delegate)}else{if((f<0&&this._scrollingCumulativeDelta>0)||(f>0&&this._scrollingCumulativeDelta<0)){this._scrollingCumulativeDelta=0}}this._scrollingCumulativeDelta+=f;var c=this.isHorizontal()?"x":"y";var d=this.contentOffset.copy();d[c]-=f;this.setContentOffsetAnimated(d,false);var b=this.indexFromPoint();this.pageControl.setCurrentPageWithoutEvent(b);var a=this;this._scrollingTimer&&clearTimeout(this._scrollingTimer);this._scrollingTimer=setTimeout((function(){var h=this.indexFromPoint();if(h!=this.focusedIndex){this._scrolling=false;this.focusCellAtIndexAnimated(h,true);this._scrolling=true}else{var g=this.pointFromIndex(h);this.setContentOffsetAnimated(g,true)}this.clearMousewheel()}).bind(this),100)}};iAP.GalleryView.prototype.dispatchUIEventToContent=function(b,a){!this.pageControl.layer.contains(this.originalTarget)&&this.callSuper(b,a)};iAP.GalleryView.prototype.panningGestureDidChange=function(){this.callSuper.apply(this,arguments);var a=this.indexFromPoint();this.pageControl.setCurrentPageWithoutEvent(a)};iAP.GalleryView.prototype.touchesBeganInCapturePhase=function(a){if(!this.scrollEnabled||!this.tracking){return}a.stopPropagation()};iAP.GalleryView.prototype.setupChildLayers=function(){this.mask=document.createElement("div");this.mask.addClassName("iap-gallery-view-mask");this.mask.appendChild(this._hostingLayer);this.layer.appendChild(this.mask);var a=this.isVertical()?iAP.GalleryView.VERTICAL_CLASS_NAME:iAP.GalleryView.HORIZONTAL_CLASS_NAME;this.layer.addClassName(a)};iAP.GalleryView.prototype.displayVisibleCells=function(c){var b=this.indexFromPoint();if(b==this._previousDisplayedIndex&&!c){return}if(this.cells.length){var e=this.largerDimension();var a=Math.ceil(this.size[e]/this.cells[0].size[e]/2);var f=b-a;var d=b+a;this.cells.forEach(function(g,h){var j=(h>=f&&h<=d)?"block":"";g.setLayerStyle({display:j})});this._previousDisplayedIndex=b}};iAP.GalleryView.prototype.isVertical=function(){return this._orientation==iAP.GalleryView.VERTICAL_ORIENTATION};iAP.GalleryView.prototype.isHorizontal=function(){return this._orientation==iAP.GalleryView.HORIZONTAL_ORIENTATION};iAP.GalleryView.prototype.isCellLengthPercentage=function(){return typeof this._cellLength==="string"&&this._cellLength.slice(-1)==="%"};iAP.GalleryView.prototype.pointFromIndex=function(b){if(!isFinite(b)){b=this.focusedIndex}var c=this.pageSize||this.size;var a=this.isVertical()?new iAd.Point(0,b*c.height):new iAd.Point(b*c.width,0);return a};iAP.GalleryView.prototype.floatIndexFromPoint=function(a){if(!a){a=this.contentOffset}var d=this.largerDimension();var b=this.largerAxis();var c=a[b]/this.pageSize[d];return iAd.Number.clampValue(c,0,this.numberOfCells-1)};iAP.GalleryView.prototype.indexFromPoint=function(a){var c=this.floatIndexFromPoint(a);var b=Math.round(c);return b};iAP.GalleryView.prototype.scaleCells=function(){this.scaleCellsAnimated(false)};iAP.GalleryView.prototype.scaleCellsAnimated=function(e){var c=this.largerAxis(),g=this.largerDimension(),a=this.contentOffset[c]/this.pageSize[g],d=Math.floor(a),b=Math.ceil(a),f=function(j,k){if(e){j.layer.style.webkitTransitionDuration=iAd.ScrollView.PAGING_TRANSITION_DURATION+"s"}else{j.layer.style.webkitTransitionDuration=0}if(k==d&&k==b){h=1}else{if(k==d){h=this.scaleFactor+(1-this.scaleFactor)*(b-a)}else{if(k==b){h=this.scaleFactor+(1-this.scaleFactor)*(a-d)}else{h=this.scaleFactor}}}j.transform="scale3d("+h+", "+h+", 1)"},h;this.cells.forEach(f,this)};iAP.GalleryView.prototype.largerDimension=function(){return this.isVertical()?"height":"width"};iAP.GalleryView.prototype.smallerDimension=function(){return this.isVertical()?"width":"height"};iAP.GalleryView.prototype.largerAxis=function(){return this.isVertical()?"y":"x"};iAP.GalleryView.prototype.smallerAxis=function(){return this.isVertical()?"x":"y"};iAd.PageControl.prototype.setCurrentPageWithoutEvent=function(a){if(this._currentPage==a||a<0||a>=this.numberOfPages){return}this._currentPage=a;if(!this.defersCurrentPageDisplay){this.updateCurrentPageDisplay()}};