
/**
*
* Copyright Â© 2009-2011 Apple Inc.  All rights reserved.
*
**/

iAd.Class({name:"iAd.ScrollViewPanGestureRecognizer",synthesizedProperties:["enabled"]});iAd.ScrollViewPanGestureRecognizer.prototype.init=function(){this.callSuper();this.view=null;this.delegate=null;this.identifier=null;this.translation=new iAd.Point();this.tracking=false;this.detectedPanning=false;this.panning=false;this.trackingDataPoints=[];this._enabled=true};iAd.ScrollViewPanGestureRecognizer.MINIMUM_TRACKING_FOR_PAN=10;iAd.ScrollViewPanGestureRecognizer.MAX_TIME_FOR_TRACKING_DATA_POINTS=100;iAd.ScrollViewPanGestureRecognizer.PANNING_DID_FAIL="panningGestureDidFail";iAd.ScrollViewPanGestureRecognizer.PANNING_DID_START="panningGestureDidStart";iAd.ScrollViewPanGestureRecognizer.PANNING_DID_CHANGE="panningGestureDidChange";iAd.ScrollViewPanGestureRecognizer.PANNING_DID_END="panningGestureDidEnd";iAd.ScrollViewPanGestureRecognizer.PANNING_DID_CANCEL="panningGestureDidCancel";iAd.ScrollViewPanGestureRecognizer.prototype.touchBegan=function(b,a){if(this.tracking){return}this.startTouchPosition=iAd.Point.fromEvent(b);this.startTouchPositionInView=iAd.Point.fromEventInElement(b,this.view.layer);this.tracking=true;this.addTrackingDataPoint(this.startTouchPositionInView,a)};iAd.ScrollViewPanGestureRecognizer.prototype.touchMoved=function(d,c){this.lastTouchPositionInView=iAd.Point.fromEventInElement(d,this.view.layer);this.addTrackingDataPoint(this.lastTouchPositionInView,c);var b=iAd.Point.fromEvent(d);this.translation=new iAd.Point(b.x-this.startTouchPosition.x,b.y-this.startTouchPosition.y);if(this.panning){this.notifyDelegateOfStateChange(iAd.ScrollViewPanGestureRecognizer.PANNING_DID_CHANGE,c)}else{var a=iAd.ScrollViewPanGestureRecognizer.MINIMUM_TRACKING_FOR_PAN;if(Math.abs(this.translation.x)>=a||Math.abs(this.translation.y)>=a){this.detectedPanning=true}}};iAd.ScrollViewPanGestureRecognizer.prototype.touchEnded=function(b,a){if(this.panning){this.notifyDelegateOfStateChange(iAd.ScrollViewPanGestureRecognizer.PANNING_DID_END,a)}this.reset()};iAd.ScrollViewPanGestureRecognizer.prototype.touchCancelled=function(b,a){if(this.panning){this.notifyDelegateOfStateChange(iAd.ScrollViewPanGestureRecognizer.PANNING_DID_CANCEL,a)}this.reset()};iAd.ScrollViewPanGestureRecognizer.prototype.reset=function(){this.tracking=false;this.detectedPanning=false;this.panning=false;this.trackingDataPoints=[];this.lastTouchPositionInView=null;this.identifier=null};iAd.ScrollViewPanGestureRecognizer.prototype.setEnabled=function(a){if(a==this._enabled){return}this._enabled=a;if(!a){if(this.panning){this.touchCancelled()}iAd.ScrollViewPanGestureRecognizer.recognizerWasDisabled(this)}};iAd.ScrollViewPanGestureRecognizer.prototype.notifyDelegateOfStateChange=function(c,a,b){if(this.delegate!=null&&iAd.Utils.objectHasMethod(this.delegate,c)){this.delegate[c](this,a,b)}};iAd.ScrollViewPanGestureRecognizer.prototype.gestureWasRecognized=function(a){this.startTouchPosition=this.trackingDataPoints[0].point;if(this.lastTouchPositionInView){this.startTouchPositionInView=this.lastTouchPositionInView.copy()}this.detectedPanning=false;this.panning=true;this.notifyDelegateOfStateChange(iAd.ScrollViewPanGestureRecognizer.PANNING_DID_START,a)};iAd.ScrollViewPanGestureRecognizer.prototype.gestureWasNotRecognized=function(a,b){this.notifyDelegateOfStateChange(iAd.ScrollViewPanGestureRecognizer.PANNING_DID_FAIL,a,b);this.reset()};iAd.ScrollViewPanGestureRecognizer.prototype.translationInView=function(){return new iAd.Point(this.lastTouchPositionInView.x-this.startTouchPositionInView.x,this.lastTouchPositionInView.y-this.startTouchPositionInView.y)};iAd.ScrollViewPanGestureRecognizer.prototype.velocityInView=function(){this.purgeTrackingDataPointsWithTime(new Date().getTime());if(this.trackingDataPoints.length<2){return new iAd.Point(0,0)}var b=this.trackingDataPoints[0];var c=this.trackingDataPoints[this.trackingDataPoints.length-1];var a=(c.time-b.time)/1000;return new iAd.Point((c.point.x-b.point.x)/a,(c.point.y-b.point.y)/a)};iAd.ScrollViewPanGestureRecognizer.prototype.purgeTrackingDataPointsWithTime=function(a){while(this.trackingDataPoints.length>0){if(a-this.trackingDataPoints[0].time<=iAd.ScrollViewPanGestureRecognizer.MAX_TIME_FOR_TRACKING_DATA_POINTS){break}this.trackingDataPoints.shift()}};iAd.ScrollViewPanGestureRecognizer.prototype.addTrackingDataPoint=function(a,b){var c=b.timeStamp;this.purgeTrackingDataPointsWithTime(c);this.trackingDataPoints.push({time:c,point:a})};iAd.ScrollViewPanGestureRecognizer.recognizers=[];iAd.ScrollViewPanGestureRecognizer.recognizersForTouch={};iAd.ScrollViewPanGestureRecognizer.panningTouchIdentifiers=[];iAd.ScrollViewPanGestureRecognizer.registerRecognizerWithTouch=function(a,b){if(!a.enabled||this.recognizers.indexOf(a)!=-1||!a.view.userInteractionEnabled){return}a.identifier=b.identifier;this.recognizers.push(a);if(this.recognizersForTouch[a.identifier]==undefined){this.recognizersForTouch[a.identifier]=[]}this.recognizersForTouch[a.identifier].push(a);if(this.recognizers.length==1){window.addEventListener(iAd.Event.MOVE_EVENT,this.handleEventProxy,true);window.addEventListener(iAd.Event.END_EVENT,this.handleEventProxy,true);window.addEventListener(iAd.Event.CANCEL_EVENT,this.handleEventProxy,true)}};iAd.ScrollViewPanGestureRecognizer.stopTrackingTouchIdentifier=function(b){var a=this.recognizersForTouch[b];if(a==undefined){return}while(a.length){iAd.Array.removeObjectFromArray(a.pop(),this.recognizers)}delete this.recognizersForTouch[b];if(this.recognizers.length==0){window.removeEventListener(iAd.Event.MOVE_EVENT,this.handleEventProxy,true);window.removeEventListener(iAd.Event.END_EVENT,this.handleEventProxy,true);window.removeEventListener(iAd.Event.CANCEL_EVENT,this.handleEventProxy,true)}iAd.Array.removeObjectFromArray(b,this.panningTouchIdentifiers)};iAd.ScrollViewPanGestureRecognizer.recognizerWasDisabled=function(a){var b=this.recognizersForTouch[a.identifier];if(b==undefined){return}iAd.Array.removeObjectFromArray(a,b);iAd.Array.removeObjectFromArray(a,this.recognizers);if(b.length==0){this.stopTrackingTouchIdentifier(a.identifier)}};iAd.ScrollViewPanGestureRecognizer.handleEventProxy=function(a){iAd.ScrollViewPanGestureRecognizer.handleEvent(a)};iAd.ScrollViewPanGestureRecognizer.handleEvent=function(a){if(a.hasOwnProperty("_synthetic")){return}var k=a.changedTouches;if(!iAd.Event.SUPPORTS_TOUCHES){a.identifier=0;k=[a]}if(a.type===iAd.Event.START_EVENT){this.setupRecognizersForTouches(k,a)}var e,h,c;for(var f=0,g=k.length;f<g;f++){e=k[f];h=this.recognizersForTouch[e.identifier];if(h){for(var d=0,b=h.length;d<b;d++){c=h[d];this.sendEventToRecognizer(c,a,e)}}if(a.type==iAd.Event.MOVE_EVENT&&this.panningTouchIdentifiers.indexOf(e.identifier)==-1){this.checkRecognizersWithTouchIdentifierForPanning(e.identifier,a)}if(a.type==iAd.Event.END_EVENT){this.stopTrackingTouchIdentifier(e.identifier)}}};iAd.ScrollViewPanGestureRecognizer.parentScrollViewForView=function(a){while(a.superview){a=a.superview;if(a instanceof iAd.ScrollView){return a}}return null};iAd.ScrollViewPanGestureRecognizer.scrollViewHasPanningChildScrollView=function(a){var d=a.scrollViews;for(var b=0,c=d.length;b<c;b++){if(d[b].dragging){return true}}return false};iAd.ScrollViewPanGestureRecognizer.scrollViewHasPanningParentScrollView=function(a){var b=this.parentScrollViewForView(a);while(b!=null){if(b.dragging){return true}b=this.parentScrollViewForView(b)}return iAd.ScrollView.hostScrollView.dragging};iAd.ScrollViewPanGestureRecognizer.hasRecognizerTrackingNativeScrollView=function(){for(var a=0,b=this.recognizers.length;a<b;a++){if(this.recognizers[a].view.usesNativeScrolling){return true}}return false};iAd.ScrollViewPanGestureRecognizer.setupRecognizersForTouches=function(g,b){var f,m,j,c,k,a;for(var e=0,h=g.length;e<h;e++){f=g[e];k=iAd.View.nearestViewForElement(f.target)||iAd.ScrollView.hostScrollView;if(k==null){continue}a=(k instanceof iAd.ScrollView)?k:this.parentScrollViewForView(k);a=a||iAd.ScrollView.hostScrollView;if(a==null||a.dragging||this.scrollViewHasPanningChildScrollView(a)||this.scrollViewHasPanningParentScrollView(a)){continue}var l=null;while(k){l=this.processViewRecognizersForTouch(k,f);k=k.superview}var d=iAd.ScrollView.hostScrollView;d.touchesBegan(b);this.registerRecognizerWithTouch(d.gestureRecognizers[0],f);if(l){l.touchBegan(f,b);this.gestureWasRecognized(l,b)}}};iAd.ScrollViewPanGestureRecognizer.processViewRecognizersForTouch=function(a,f){var b=a.gestureRecognizers;var c=null;if(b.length>0&&a.pointInside(iAd.Point.fromEventInElement(f,a.layer))){for(var d=0,e=b.length;d<e;d++){recognizer=b[d];if(recognizer.tracking){return}if(a.decelerating){c=recognizer}a.touchesBegan(event);this.registerRecognizerWithTouch(recognizer,f)}}return c};iAd.ScrollViewPanGestureRecognizer.checkRecognizersWithTouchIdentifierForPanning=function(c,b){var g=this.recognizersForTouch[c];if(g==undefined){return}var d,h,a;for(var e=0,f=g.length;e<f;e++){d=g[e];if(d.panning){return}if(!d.detectedPanning){continue}h=d.view;var j=iAd.ScrollViewPanGestureRecognizer.MINIMUM_TRACKING_FOR_PAN;a=(Math.abs(d.translation.x)>=j&&(h.canScrollHorizontally||h.alwaysBounceHorizontal))||(Math.abs(d.translation.y)>=j&&(h.canScrollVertically||h.alwaysBounceVertical));if(a){this.gestureWasRecognized(d,b);break}}};iAd.ScrollViewPanGestureRecognizer.gestureWasRecognized=function(a,d){a.gestureWasRecognized(d);this.panningTouchIdentifiers.push(a.identifier);var b=this.recognizersForTouch[a.identifier];for(var c=b.length;c--;){if(b[c]!=a){b[c].gestureWasNotRecognized(d,a);iAd.Array.removeObjectFromArray(b[c],this.recognizers);b.splice(c,1)}}};iAd.ScrollViewPanGestureRecognizer.sendEventToRecognizer=function(a,b,c){switch(b.type){case iAd.Event.START_EVENT:a.touchBegan(c,b);break;case iAd.Event.MOVE_EVENT:a.touchMoved(c,b);break;case iAd.Event.END_EVENT:a.touchEnded(c,b);break;case iAd.Event.CANCEL_EVENT:a.touchCancelled(c,b);break}};document.addEventListener(iAd.Event.START_EVENT,iAd.ScrollViewPanGestureRecognizer.handleEventProxy,true);