
/**
*
* Copyright Â© 2009-2011 Apple Inc.  All rights reserved.
*
**/

iAd.Class({name:"iAd.Media",mixins:[iAd.EventTarget,iAd.EventTriage],synthesizedProperties:["url","element","time","duration","percentLoaded","bufferedStartTime","bufferedEndTime","canPlay","canPlayThrough","seeking","renderable","loop","error","playbackState","loadState","loadReady"],archivedProperties:["url"]});iAd.Media.PLAYBACK_WILL_START="mediaPlaybackWillStart";iAd.Media.PLAYBACK_DID_START="mediaPlaybackDidStart";iAd.Media.PLAYBACK_DID_PAUSE="mediaPlaybackDidPause";iAd.Media.PLAYBACK_DID_BEGIN_WAITING="mediaPlaybackDidBeginWaiting";iAd.Media.PLAYBACK_DID_END_WAITING="mediaPlaybackDidEndWaiting";iAd.Media.PLAYBACK_DID_END="mediaPlaybackDidEnd";iAd.Media.WILL_SEEK="mediaWillSeek";iAd.Media.DID_SEEK="mediaDidSeek";iAd.Media.DID_UPDATE_TIME="mediaDidUpdateTime";iAd.Media.LOAD_WILL_START="mediaLoadWillStart";iAd.Media.LOAD_DID_START="mediaLoadDidStart";iAd.Media.LOAD_DID_PROGRESS="mediaLoadDidProgress";iAd.Media.LOAD_DATA_AVAILABLE="mediaLoadDataAvailable";iAd.Media.LOAD_DID_STALL="mediaLoadDidStall";iAd.Media.LOAD_DID_SUSPEND="mediaLoadDidSuspend";iAd.Media.LOAD_DID_RESUME="mediaLoadDidResume";iAd.Media.LOAD_DID_FAIL="mediaLoadDidFail";iAd.Media.LOAD_IS_READY="mediaLoadIsReady";iAd.Media.LOAD_CAN_PLAY="mediaLoadCanPlay";iAd.Media.LOAD_CAN_PLAY_THROUGH="mediaLoadCanPlayThrough";iAd.Media.WILL_UNLOAD="mediaWillUnload";iAd.Media.DID_UNLOAD="mediaDidUnload";iAd.Media.PLAYBACK_STATE_DID_UPDATE="mediaPlaybackStateDidUpdate";iAd.Media.PLAYBACK_STATE_NONE=0;iAd.Media.PLAYBACK_STATE_WAITING=1;iAd.Media.PLAYBACK_STATE_PLAYING=2;iAd.Media.PLAYBACK_STATE_PAUSED=3;iAd.Media.PLAYBACK_STATE_ENDED=4;iAd.Media.LOAD_STATE_DID_UPDATE="mediaLoadStateDidUpdate";iAd.Media.LOAD_STATE_NONE=0;iAd.Media.LOAD_STATE_LOADING=1;iAd.Media.LOAD_STATE_STALLED=2;iAd.Media.LOAD_STATE_SUSPENDED=3;iAd.Media.LOAD_STATE_FAILED=4;iAd.Media.READY_STATE_NOTHING=0;iAd.Media.READY_STATE_METADATA=1;iAd.Media.READY_STATE_CURRENT_DATA=2;iAd.Media.READY_STATE_FUTURE_DATA=3;iAd.Media.READY_STATE_ENOUGH_DATA=4;iAd.Media.HTML_MEDIA_EVENTS=["emptied","loadstart","durationchange","loadedmetadata","loadeddata","canplay","canplaythrough","progress","play","waiting","playing","timeupdate","pause","seeking","seeked","stalled","suspend","ended","abort","error"];iAd.Media.prototype.init=function(a){this.callSuper();this._playbackState=iAd.Media.PLAYBACK_STATE_NONE;this._loadState=iAd.Media.LOAD_STATE_NONE;this.reset();if(!this._loadReadyStrategy){this._loadReadyStrategy=iAd.Media.defaultLoadReadyStrategy}this.eventTarget=document;this._url=a;this.resolvedURL=this.urlStrategy(a)};iAd.Media.prototype.getDuration=function(){return this._element?this._element.duration:NaN};iAd.Media.prototype.getBufferedStartTime=function(){var a=this.closestBufferedIndex();return(a>=0)?this._element.buffered.start(a):0};iAd.Media.prototype.getBufferedEndTime=function(){var a=this.closestBufferedIndex();return(a>=0)?this._element.buffered.end(a):0};iAd.Media.prototype.getPercentLoaded=function(){return this.duration?(this.bufferedEndTime-this.bufferedStartTime)/this.duration:0};iAd.Media.prototype.closestBufferedIndex=function(){if(!this._element){return -1}var e=this.time,d=-1,b=this.element.buffered;for(var a=0,c=b.length;a<c;a++){if(b.start(a)<=e&&b.end(a)>=e){return a}}return d};iAd.Media.prototype.setLoop=function(a){this._loop=a;if(this._element){this._element.loop=a}};iAd.Media.prototype.getCanPlay=function(){if(!this._element){return false}return(this._element.readyState>=iAd.Media.READY_STATE_FUTURE_DATA)};iAd.Media.prototype.getCanPlayThrough=function(){if(!this._element){return false}return(this._element.readyState>=iAd.Media.READY_STATE_ENOUGH_DATA)};iAd.Media.prototype.getSeeking=function(){return(this._element&&this._element.seeking)};iAd.Media.prototype.getError=function(){var a=this._element;return(a&&a.error)?a.error.code:null};iAd.Media.prototype.getRenderable=function(){if(!this._element){return false}return(this._element.readyState>=iAd.Media.READY_STATE_CURRENT_DATA)};iAd.Media.prototype.setUrl=function(a){};iAd.Media.prototype.setElement=function(a){};iAd.Media.prototype.setPlaybackState=function(a){};iAd.Media.prototype.setLoadState=function(a){};iAd.Media.prototype.setLoadReady=function(a){};iAd.Media.prototype.setTime=function(a){};iAd.Media.prototype.load=function(){if((this._loadState!=iAd.Media.LOAD_STATE_NONE&&this._loadState!=iAd.Media.LOAD_STATE_FAILED)||this._attemptingLoad){return false}this.element.setAttribute("src",this.resolvedURL);this.element.loop=this._loop;this.addMediaEventListeners();this.dispatchMediaNotification(iAd.Media.LOAD_WILL_START);this._attemptingLoad=true;this.loadElement();if(iAd.Media.preloadedMedia&&iAd.Media.preloadedMedia.url!=this.url){iAd.Media.preloadedMedia=null}return true};iAd.Media.prototype.unload=function(){if(this._loadState==iAd.Media.LOAD_STATE_NONE){return}this.dispatchMediaNotification(iAd.Media.WILL_UNLOAD);this.removeMediaEventListeners();this.reset();this.unloadElement();this.dispatchMediaNotification(iAd.Media.DID_UNLOAD)};iAd.Media.prototype.play=function(){if(this._playbackState==iAd.Media.PLAYBACK_STATE_PLAYING||this._playbackState==iAd.Media.PLAYBACK_STATE_WAITING){if(this._targetPlaybackState!=iAd.Media.PLAYBACK_STATE_PAUSED){return false}}if(this._loadState==iAd.Media.LOAD_STATE_NONE||this._loadState==iAd.Media.LOAD_STATE_FAILED){this.load()}if(this._playbackState!=iAd.Media.PLAYBACK_STATE_PLAYING&&this._targetPlaybackState!=iAd.Media.PLAYBACK_STATE_PLAYING){this.dispatchMediaNotification(iAd.Media.PLAYBACK_WILL_START)}this.playElement();return true};iAd.Media.prototype.pause=function(){if(this._playbackState==iAd.Media.PLAYBACK_STATE_PAUSED){return false}this.pauseElement();return true};iAd.Media.prototype.stop=function(){if(this._playbackState==iAd.Media.PLAYBACK_STATE_PAUSED&&this.time==0){return false}this.pause();this.seekToTime(0);return true};iAd.Media.prototype.seekToTime=function(a){if(!this.canSeekToTime(a)){return false}this.seekElement(a);if(this.playbackState==iAd.Media.PLAYBACK_STATE_ENDED){this.enterPlaybackState(iAd.Media.PLAYBACK_STATE_PAUSED)}return true};iAd.Media.prototype.canSeekToTime=function(d){if(!this._element){return false}var c=this._element.seekable;for(var a=0,b=c.length;a<b;a++){if(c.start(a)<=d&&c.end(a)>=d){return true}}return false};iAd.Media.prototype.isTimeInBufferedRange=function(a){return(this.bufferedStartTime<=a&&this.bufferedEndTime>=a)};iAd.Media.prototype.loadElement=function(){this.element.load()};iAd.Media.prototype.unloadElement=function(){this.element.setAttribute("src","null")};iAd.Media.prototype.playElement=function(){this._targetPlaybackState=iAd.Media.PLAYBACK_STATE_PLAYING;this.element.play()};iAd.Media.prototype.pauseElement=function(){this._targetPlaybackState=iAd.Media.PLAYBACK_STATE_PAUSED;this.element.pause()};iAd.Media.prototype.seekElement=function(a){this.element.currentTime=a};iAd.Media.prototype.reset=function(){this.enterPlaybackState(iAd.Media.PLAYBACK_STATE_NONE);this.enterLoadState(iAd.Media.LOAD_STATE_NONE);this._loadReady=false;this._attemptingLoad=false;this._time=0};iAd.Media.prototype.executeLoadReadyStrategy=function(a){if(!this._loadReady&&this.loadReadyStrategy(this,a)){this._loadReady=true;this.dispatchMediaNotification(iAd.Media.LOAD_IS_READY)}};iAd.Media.prototype.prepareForCompetition=function(){};iAd.Media.prototype.enterPlaybackState=function(b){if(b==iAd.Media.PLAYBACK_STATE_PLAYING||b==iAd.Media.PLAYBACK_STATE_PAUSED){delete this._targetPlaybackState}if(this._playbackState==b){return}var a=this._playbackState;this._playbackState=b;this.dispatchMediaNotification(iAd.Media.PLAYBACK_STATE_DID_UPDATE);if(a==iAd.Media.PLAYBACK_STATE_WAITING){this.dispatchMediaNotification(iAd.Media.PLAYBACK_DID_END_WAITING)}switch(b){case iAd.Media.PLAYBACK_STATE_PLAYING:this.dispatchMediaNotification(iAd.Media.PLAYBACK_DID_START);break;case iAd.Media.PLAYBACK_STATE_PAUSED:this.dispatchMediaNotification(iAd.Media.PLAYBACK_DID_PAUSE);break;case iAd.Media.PLAYBACK_STATE_WAITING:this.dispatchMediaNotification(iAd.Media.PLAYBACK_DID_BEGIN_WAITING);break;case iAd.Media.PLAYBACK_STATE_ENDED:this.dispatchMediaNotification(iAd.Media.PLAYBACK_DID_END);break}};iAd.Media.prototype.enterLoadState=function(b){if(this._loadState==b){return}this.clearLoadStateTimeout();this.clearTimeupdateWatchdogTimeout();var a=this._loadState;this._loadState=b;this.dispatchMediaNotification(iAd.Media.LOAD_STATE_DID_UPDATE);this._attemptingLoad=false;switch(b){case iAd.Media.LOAD_STATE_LOADING:this.dispatchMediaNotification(a?iAd.Media.LOAD_DID_RESUME:iAd.Media.LOAD_DID_START);break;case iAd.Media.LOAD_STATE_STALLED:this.dispatchMediaNotification(iAd.Media.LOAD_DID_STALL);if(this._playbackState==iAd.Media.PLAYBACK_STATE_PLAYING){this.beginTimeupdateWatchdogTimeout()}break;case iAd.Media.LOAD_STATE_SUSPENDED:this.dispatchMediaNotification(iAd.Media.LOAD_DID_SUSPEND);break;case iAd.Media.LOAD_STATE_FAILED:this.dispatchMediaNotification(iAd.Media.LOAD_DID_FAIL,[["errorCode",this.error]]);break}};iAd.Media.prototype.elementWasRemovedFromDocument=function(){};iAd.Media.prototype.elementWasInsertedIntoDocument=function(){};iAd.Media.prototype.addMediaEventListeners=function(){var c=iAd.Media.HTML_MEDIA_EVENTS,b=this.element;for(var a=0,d=c.length;a<d;a++){b.addEventListener(c[a],this)}};iAd.Media.prototype.removeMediaEventListeners=function(){var c=iAd.Media.HTML_MEDIA_EVENTS,b=this.element;for(var a=0,d=c.length;a<d;a++){b.removeEventListener(c[a],this)}};iAd.Media.prototype.dispatchMediaNotification=function(a,b){this.notifyDelegate(a,iAd.Media,b);this.notifyDelegate(a,this._mediaPlayer,b);this.dispatchNotification(a,this.delegate,b)};iAd.Media.prototype.processDelegateArguments=function(b){var a=[this];if(b){a=a.concat(b.map(function(c){return c[1]}))}return a};iAd.Media.prototype.handlePlay=function(a){if(this._targetPlaybackState!=iAd.Media.PLAYBACK_STATE_PLAYING){this._targetPlaybackState=iAd.Media.PLAYBACK_STATE_PLAYING;this.dispatchMediaNotification(iAd.Media.PLAYBACK_WILL_START)}};iAd.Media.prototype.handlePlaying=function(a){this.enterPlaybackState(iAd.Media.PLAYBACK_STATE_PLAYING)};iAd.Media.prototype.handlePause=function(a){if(this.playbackState!=iAd.Media.PLAYBACK_STATE_ENDED&&!this._element.ended){this.enterPlaybackState(iAd.Media.PLAYBACK_STATE_PAUSED)}};iAd.Media.prototype.handleWaiting=function(a){this.enterPlaybackState(iAd.Media.PLAYBACK_STATE_WAITING)};iAd.Media.prototype.handleSeeking=function(a){this.dispatchMediaNotification(iAd.Media.WILL_SEEK)};iAd.Media.prototype.handleSeeked=function(a){this.dispatchMediaNotification(iAd.Media.DID_SEEK)};iAd.Media.prototype.handleEnded=function(a){this.pauseElement();this.enterPlaybackState(iAd.Media.PLAYBACK_STATE_ENDED)};iAd.Media.prototype.handleTimeupdate=function(b){var a=this._element.currentTime;this.clearTimeupdateWatchdogTimeout();if(this._time==a){return}this._time=a;this.dispatchMediaNotification(iAd.Media.DID_UPDATE_TIME,[["time",this._time]])};iAd.Media.prototype.handleDurationchange=function(a){this.notifyPropertyChange("duration");this.enterLoadState(iAd.Media.LOAD_STATE_LOADING)};iAd.Media.prototype.handleLoadstart=function(a){this.enterLoadState(iAd.Media.LOAD_STATE_LOADING)};iAd.Media.prototype.handleLoadedmetadata=function(a){this.enterLoadState(iAd.Media.LOAD_STATE_LOADING)};iAd.Media.prototype.handleLoadeddata=function(a){this.dispatchMediaNotification(iAd.Media.LOAD_DATA_AVAILABLE);this.enterLoadState(iAd.Media.LOAD_STATE_LOADING);this.notifyPropertyChange("renderable")};iAd.Media.prototype.handleProgress=function(a){this.enterLoadState(iAd.Media.LOAD_STATE_LOADING);this.dispatchMediaNotification(iAd.Media.LOAD_DID_PROGRESS,[["percentLoaded",this.percentLoaded]]);this.executeLoadReadyStrategy(a)};iAd.Media.prototype.handleSuspend=function(a){this.beginLoadStateTimeout(iAd.Media.LOAD_STATE_SUSPENDED)};iAd.Media.prototype.handleStalled=function(a){this.beginLoadStateTimeout(iAd.Media.LOAD_STATE_STALLED)};iAd.Media.prototype.handleError=function(a){this.enterLoadState(iAd.Media.LOAD_STATE_FAILED)};iAd.Media.prototype.handleCanplay=function(a){this.dispatchMediaNotification(iAd.Media.LOAD_CAN_PLAY);this.executeLoadReadyStrategy(a)};iAd.Media.prototype.handleCanplaythrough=function(a){this.dispatchMediaNotification(iAd.Media.LOAD_CAN_PLAY_THROUGH);this.executeLoadReadyStrategy(a)};iAd.Media.prototype.handleAbort=function(a){if(this._loadState!=iAd.Media.LOAD_STATE_NONE){this.enterLoadState(iAd.Media.LOAD_STATE_FAILED)}};iAd.Media.prototype.handleEmptied=function(a){this.notifyPropertyChange("renderable");if(this._loadState!=iAd.Media.LOAD_STATE_NONE){this.handleUnloadEvent()}};iAd.Media.prototype.handleUnloadEvent=function(a){this.removeMediaEventListeners();this.reset();this.dispatchMediaNotification(iAd.Media.DID_UNLOAD)};iAd.Media.prototype.beginLoadStateTimeout=function(a){this.clearLoadStateTimeout();this.loadStateTimeout=this.callMethodNameAfterDelay("enterLoadState",0.05,a)};iAd.Media.prototype.clearLoadStateTimeout=function(){if(this.loadStateTimeout){clearTimeout(this.loadStateTimeout);this.loadStateTimeout=null}};iAd.Media.TIMEUPDATE_WATCHDOG_DELAY=0.3;iAd.Media.prototype.beginTimeupdateWatchdogTimeout=function(){this.clearTimeupdateWatchdogTimeout();this.timeupdateWatchdogTimeout=this.callMethodNameAfterDelay("timeupdateWatchdogDidTimeout",iAd.Media.TIMEUPDATE_WATCHDOG_DELAY)};iAd.Media.prototype.clearTimeupdateWatchdogTimeout=function(){if(this.timeupdateWatchdogTimeout){clearTimeout(this.timeupdateWatchdogTimeout);delete this.timeupdateWatchdogTimeout}};iAd.Media.prototype.timeupdateWatchdogDidTimeout=function(){if(this._loadState==iAd.Media.LOAD_STATE_STALLED){delete this.timeupdateWatchdogTimeout;this.pause()}};iAd.Media.defaultLoadReadyStrategy=function(a){return a.canPlayThrough||(!iAd.Device.iOS_VERSION&&a.percentLoaded==1)};iAd.Media.defaultUrlStrategy=function(a){return a};iAd.Media.loadReadyStrategy=iAd.Media.defaultLoadReadyStrategy;iAd.Media.urlStrategy=iAd.Media.defaultUrlStrategy;iAd.Media.prototype.loadReadyStrategy=function(b,a){return iAd.Media.loadReadyStrategy(b,a)};iAd.Media.prototype.urlStrategy=function(a){return iAd.Media.urlStrategy?iAd.Media.urlStrategy(a):a};iAd.Media.mediaTypeForURL=function(d,a){if(iAd.Media.preloadedMedia&&a==iAd.Media.preloadedMedia.url){return iAd.Media.preloadedMedia}var b=this.resolveMediaClass(d);var c=new b(a);return c};iAd.Media.resolveMediaClass=function(a){return a};iAd.Media.activeMedia=[];iAd.Media.mediaPlaybackWillStart=function(a){this.registerActiveMedia(a)};iAd.Media.mediaLoadWillStart=function(a){this.registerActiveMedia(a)};iAd.Media.mediaDidUnload=function(a){this.unregisterActiveMedia(a)};iAd.Media.registerActiveMedia=function(b){var a=this.activeMedia[0];this.unregisterActiveMedia(b);this.activeMedia.unshift(b);if(a&&a!=b){a.prepareForCompetition()}};iAd.Media.unregisterActiveMedia=function(a){iAd.Array.removeObjectFromArray(a,this.activeMedia)};iAd.Media.preloadedMedia=null;