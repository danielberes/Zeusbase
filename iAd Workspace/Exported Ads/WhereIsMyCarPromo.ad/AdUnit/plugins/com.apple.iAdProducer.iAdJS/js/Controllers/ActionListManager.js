
/**
*
* Copyright Â© 2009-2011 Apple Inc.  All rights reserved.
*
**/

iAd.Class({name:"iAd.ActionListManager",mixins:[iAd.EventTarget]});iAd.ActionListManager.ACTIVE_STATE_SUFFIX="-is-active";iAd.ActionListManager.ACTION_LIST_WILL_START="actionListWillStart";iAd.ActionListManager.ACTION_LIST_DID_START="actionListDidStart";iAd.ActionListManager.ACTION_LIST_WILL_ITERATE="actionListWillIterate";iAd.ActionListManager.ACTION_LIST_DID_ITERATE="actionListDidIterate";iAd.ActionListManager.ACTION_LIST_WILL_COMPLETE="actionListWillComplete";iAd.ActionListManager.ACTION_LIST_DID_COMPLETE="actionListDidComplete";iAd.ActionListManager.ACTION_LIST_DID_CANCEL="actionListDidCancel";iAd.ActionListManager.ACTION_LIST_DID_PROGRESS="actionListDidProgress";iAd.ActionListManager.prototype.init=function(c,d){this.callSuper();this.eventTarget=document;this.id=c.id||iAd.ActionListManager.uniqueId();this.actionList=c;this.viewController=d;this.actionsByName={};this.actions=[];this.executedActions=[];this.seedActions=[];this.actionQueue=[];this.dependency={};this.selectors=[];this.timers=[];this.usesAnimationIterationCount=true;var b,a;this.actionList.actions.forEach(function(i){var n=i.type;if(n=="css-reset"){this.selectors.push(i.selector);return}var e=i.name,g=i.startAfter||[];if(n=="script"){var j=i.className,f=iAd.Utils.resolveObjectPath(j);if(!f){throw new ReferenceError("Can't find script action class named: "+j)}var l=new f(this.viewController);var m=i.properties;for(var o in m){l[o]=m[o]}if(i.delay){l.delay=i.delay}if(!i.asynchronous){l.delegate=this}l._action=i;l.prepare();i.object=l;this.usesAnimationIterationCount=false}else{if(n=="css"){this.selectors.push(i.selector);var h=i.duration||0;if(b==null){b=h}else{if(b!=h){this.usesAnimationIterationCount=false}}var k=i.delay||0;if(a==null){a=k}else{if(a!=k){this.usesAnimationIterationCount=false}}}}if(g.length>0){g.forEach(function(p){if(this.dependency[p]){this.dependency[p].push(i)}else{this.dependency[p]=[i]}},this);this.usesAnimationIterationCount=false}else{this.seedActions.push(i)}if(e){this.actionsByName[e]=i}i.completed=false;this.actions.push(i)},this);this.totalIterations=this.actionList.iterationCount||1;this.totalActions=this.actions.length};iAd.ActionListManager.prototype.start=function(){if(this.viewController.isInState(this.actionList.cssClassName)){this.reset(true);this.callMethodNameAfterDelay("start",0);return}this.clearCSSAnimationProperties();this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_WILL_START,this.viewController,[["actionList",this.actionList]]);this.viewController.enterState(this.actionList.cssClassName);this.viewController.enterState(this.actionList.cssClassName+iAd.ActionListManager.ACTIVE_STATE_SUFFIX);document.addEventListener("webkitAnimationEnd",this,true);if(this.usesAnimationIterationCount){document.addEventListener("webkitAnimationIteration",this,true)}this.completedIterationCount=0;this.iterate();this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_DID_START,this.viewController,[["actionList",this.actionList]])};iAd.ActionListManager.prototype.iterate=function(){this.viewController.enterState(this.actionList.cssClassName);this.viewController.enterState(this.actionList.cssClassName+iAd.ActionListManager.ACTIVE_STATE_SUFFIX);this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_WILL_ITERATE,this.viewController,[["actionList",this.actionList],["iteration",this.completedIterationCount]]);this.completedActionCount=0;this.actionQueue=this.seedActions.slice();this.flushActionQueue()};iAd.ActionListManager.prototype.clearCSSAnimationProperties=function(){if(this.selectors.length==0){return}var d=this.selectors.join(",");var e=Array.prototype.slice.call(document.querySelectorAll(d));var a=this.viewController.view;if(a.superview==null){e.push.apply(e,Array.prototype.slice.call(a.layer.querySelectorAll(d)))}for(var c=e.length-1;c>=0;c--){var b=e[c];b.style.webkitAnimationName="";b.style.webkitAnimationDuration="";b.style.webkitAnimationDelay="";b.style.webkitAnimationIterationCount=""}};iAd.ActionListManager.prototype.reset=function(a){document.removeEventListener("webkitAnimationEnd",this,true);if(this.usesAnimationIterationCount){document.removeEventListener("webkitAnimationIteration",this,true)}this.clearCSSAnimationProperties();this.timers.forEach(clearTimeout);this.timers=[];this.actionQueue=[];for(var b=this.executedActions.length-1;b>=0;b--){this.executedActions[b].reset()}this.executedActions=[];this.actions.forEach(function(c){c.completed=false},this);this.viewController.exitState(this.actionList.cssClassName);this.viewController.exitState(this.actionList.cssClassName+iAd.ActionListManager.ACTIVE_STATE_SUFFIX);if(a!=true){this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_DID_CANCEL,this.viewController,[["actionList",this.actionList]])}};iAd.ActionListManager.prototype.handleEvent=function(b){var c,a=b.type;if(a=="webkitAnimationEnd"||a=="webkitAnimationIteration"){c=this.actionsByName[b.animationName]}if(c==null||c.asynchronous){return}this.handleActionDidComplete(c)};iAd.ActionListManager.prototype.scriptActionDidComplete=function(a){this.handleActionDidComplete(a._action)};iAd.ActionListManager.prototype.handleActionDidComplete=function(d){if(!this.viewController.isInState(this.actionList.cssClassName)){return}if(d.completed){return}d.completed=true;this.completedActionCount++;var a=this.totalIterations=="infinite"?0:(this.completedIterationCount*this.totalActions+this.completedActionCount)/(this.totalActions*this.totalIterations);this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_DID_PROGRESS,this.viewController,[["actionList",this.actionList],["action",d],["progress",a]]);if(this.completedActionCount==this.totalActions){this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_DID_ITERATE,this.viewController,[["actionList",this.actionList],["iteration",this.completedIterationCount]]);this.completedIterationCount++;if(this.totalIterations!="infinite"&&this.completedIterationCount==this.totalIterations){this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_WILL_COMPLETE,this.viewController,[["actionList",this.actionList]]);document.removeEventListener("webkitAnimationEnd",this,true);if(this.usesAnimationIterationCount){document.removeEventListener("webkitAnimationIteration",this,true)}this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_DID_COMPLETE,this.viewController,[["actionList",this.actionList]]);this.viewController.exitState(this.actionList.cssClassName+iAd.ActionListManager.ACTIVE_STATE_SUFFIX)}else{if(this.usesAnimationIterationCount){this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_WILL_ITERATE,this.viewController,[["actionList",this.actionList],["iteration",this.completedIterationCount]]);this.actions.forEach(function(i){i.completed=false},this);this.completedActionCount=0}else{this.reset();this.callMethodNameAfterDelay("iterate",0)}}}else{var e=d.name;if(e){var m=this.dependency[e];if(m){for(var h=0,l=m.length;h<l;h++){var f=m[h];var c=f.startAfter;var n=true;for(var g=0,b=c.length;g<b;g++){var k=this.actionsByName[c[g]];if(k&&k.completed==false){n=false;break}}if(n){this.actionQueue.push(f)}}}}}this.flushActionQueue()};iAd.ActionListManager.prototype.flushActionQueue=function(){if(this.actionQueue.length==0){return}var d=[];var a={};this.actionQueue.forEach(function(l){var q=l.type;if(q=="css"){var f=document.querySelectorAll(l.selector),j=f.length;if(j>0){var p=l.name,r=l.duration+"s",g=l.delay||0+"s";for(var n=0;n<j;n++){var m=f[n];var h=m.id;if(!h){h=m.id=iAd.ActionListManager.uniqueId()}var k=a[h];if(!k){k=a[h]={keyframeNames:[p],durations:[r],delays:[g],element:m}}else{k.keyframeNames.push(p);k.durations.push(r);k.delays.push(g)}}}else{d.push(l)}}else{if(q=="script"){var o=l.object;this.executedActions.push(o);this.timers.push(o.run())}}if(l.asynchronous){d.push(l)}},this);for(var b in a){var e=a[b];var c=e.element;c.style.webkitAnimationName=e.keyframeNames.join(",");c.style.webkitAnimationDuration=e.durations.join(",");c.style.webkitAnimationDelay=e.delays.join(",");c.style.webkitAnimationFillMode="both";c.style.webkitAnimationIterationCount=this.usesAnimationIterationCount?this.totalIterations:""}this.actionQueue=[];d.forEach(this.handleActionDidComplete,this);this.flushActionQueue()};iAd.ActionListManager.uniqueId=function(){return"al-"+this._uid++};iAd.ActionListManager._uid=1;